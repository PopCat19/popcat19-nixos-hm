# ~/nixos-config/fish_functions/nixos-apply-config.fish
function nixos-apply-config -d "ğŸš€ Apply NixOS config with rebuild/git/rollback. Use 'nixos-apply-config help' for manual."
    # Show help if help requested
    if test "$argv[1]" = "help" -o "$argv[1]" = "h" -o "$argv[1]" = "--help" -o "$argv[1]" = "-h"
        _nixos_apply_help
        return 0
    else if test "$argv[1]" = "manual" -o "$argv[1]" = "man" -o "$argv[1]" = "doc"
        _nixos_apply_manual
        return 0
    end
    
    echo "ğŸš€ Attempting to apply NixOS configuration..."
    if sudo nixos-rebuild switch --flake "$NIXOS_CONFIG_DIR#$NIXOS_FLAKE_HOSTNAME" $argv
        echo "âœ… NixOS rebuild and switch successful."
        echo ""
        read -P "ğŸ’¬ Enter commit message (or leave blank to skip git operations): " commit_message
        if test -n "$commit_message"
            nixos-git "$commit_message"
        else
            echo "â„¹ï¸ Git operations skipped by user."
        end
        return 0
    else
        echo "âŒ NixOS rebuild and switch FAILED."
        echo ""
        read -P "ó°•Œ Rollback to previously working configuration? (y/N): " rollback_choice
        set -l lower_rollback_choice (string lower "$rollback_choice")
        if test "$lower_rollback_choice" = "y" -o "$lower_rollback_choice" = "yes"
            echo "ó°•Œ Attempting to rollback..."
            if sudo nixos-rebuild switch --rollback
                echo "âœ… Rollback successful. Switched to previous configuration."
            else
                echo "âŒ Rollback FAILED. You may need to manually select a previous generation at boot."
                echo "ğŸ’¡ Try 'sudo nixos-rebuild boot' to make the previous generation default for next boot."
            end
        else
            echo "â„¹ï¸ Rollback skipped by user."
        end
        return 1
    end
end

function _nixos_apply_help -d "Show help for nixos-apply-config"
    echo "ğŸš€ nixos-apply-config - Smart NixOS Configuration Applier"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ¯ DESCRIPTION:"
    echo "   Intelligently applies NixOS configuration with automatic error handling,"
    echo "   git integration, and rollback capabilities."
    echo ""
    echo "âš™ï¸  USAGE:"
    echo "   nixos-apply-config [nixos-rebuild-options]"
    echo "   nixos-apply-config help|manual"
    echo ""
    echo "ğŸ”„ WORKFLOW:"
    echo "   1. Runs nixos-rebuild switch with your flake"
    echo "   2. On SUCCESS: Offers to commit changes to git"
    echo "   3. On FAILURE: Offers to rollback to previous generation"
    echo ""
    echo "ğŸ’¡ EXAMPLES:"
    echo "   nixos-apply-config                    # Standard rebuild"
    echo "   nixos-apply-config --show-trace       # Rebuild with detailed errors"
    echo "   nixos-apply-config --fast             # Skip building substitutes"
    echo ""
    echo "ğŸ”— INTEGRATIONS:"
    echo "   â€¢ Uses \$NIXOS_CONFIG_DIR and \$NIXOS_FLAKE_HOSTNAME"
    echo "   â€¢ Calls nixos-git for commit operations"
    echo "   â€¢ Used by nrb, nerb, herb, nup abbreviations"
    echo ""
    echo "â„¹ï¸  For detailed information: nixos-apply-config manual"
end

function _nixos_apply_manual -d "Show detailed manual for nixos-apply-config"
    echo "ğŸ“– nixos-apply-config - Complete Manual"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ” OVERVIEW:"
    echo "   The core function of your NixOS management workflow. Handles the complete"
    echo "   process of applying configuration changes with intelligent error handling."
    echo ""
    echo "ğŸ”„ DETAILED WORKFLOW:"
    echo ""
    echo "   1ï¸âƒ£ REBUILD PHASE:"
    echo "      â€¢ Executes: sudo nixos-rebuild switch --flake \"\$NIXOS_CONFIG_DIR#\$NIXOS_FLAKE_HOSTNAME\""
    echo "      â€¢ Passes through any additional arguments (--show-trace, --fast, etc.)"
    echo "      â€¢ Provides real-time output during build process"
    echo ""
    echo "   2ï¸âƒ£ SUCCESS PHASE:"
    echo "      â€¢ Confirms successful rebuild"
    echo "      â€¢ Prompts for git commit message"
    echo "      â€¢ If message provided: calls nixos-git function"
    echo "      â€¢ If skipped: continues without git operations"
    echo ""
    echo "   3ï¸âƒ£ FAILURE PHASE:"
    echo "      â€¢ Reports build failure"
    echo "      â€¢ Offers rollback to previous working generation"
    echo "      â€¢ If accepted: attempts sudo nixos-rebuild switch --rollback"
    echo "      â€¢ Provides guidance if rollback also fails"
    echo ""
    echo "ğŸŒ ENVIRONMENT VARIABLES:"
    echo "   â€¢ NIXOS_CONFIG_DIR: Path to your NixOS configuration directory"
    echo "   â€¢ NIXOS_FLAKE_HOSTNAME: Your system's flake hostname identifier"
    echo ""
    echo "ğŸ”§ ADVANCED OPTIONS:"
    echo "   All nixos-rebuild switch options are supported:"
    echo "   â€¢ --show-trace          Show detailed error traces"
    echo "   â€¢ --fast                Skip building substitutes where possible"
    echo "   â€¢ --option <name> <val> Pass option to Nix"
    echo "   â€¢ --impure              Allow impure evaluation"
    echo "   â€¢ --verbose             Increase verbosity"
    echo ""
    echo "ğŸ’¡ ERROR SCENARIOS & SOLUTIONS:"
    echo ""
    echo "   âŒ Build Failures:"
    echo "      â€¢ Syntax errors in configuration files"
    echo "      â€¢ Missing packages or services"
    echo "      â€¢ Hardware compatibility issues"
    echo "      â†’ Use --show-trace for detailed error information"
    echo ""
    echo "   âŒ Flake Issues:"
    echo "      â€¢ Lock file inconsistencies"
    echo "      â€¢ Input update conflicts"
    echo "      â†’ Try flake-update first, then reapply"
    echo ""
    echo "   âŒ Permission Issues:"
    echo "      â€¢ Insufficient privileges for system changes"
    echo "      â†’ Ensure sudo access is configured properly"
    echo ""
    echo "ğŸ”— INTEGRATION WITH OTHER FUNCTIONS:"
    echo "   â€¢ nixos-edit-rebuild: Edit config â†’ nixos-apply-config"
    echo "   â€¢ home-edit-rebuild: Edit home â†’ nixos-apply-config"
    echo "   â€¢ nixos-upgrade: Update flake â†’ nixos-apply-config"
    echo "   â€¢ nixpkg add --rebuild: Add package â†’ nixos-apply-config"
    echo ""
    echo "ğŸ® ABBREVIATION USAGE:"
    echo "   nrb         = nixos-apply-config"
    echo "   nixos-sw    = nixos-apply-config"
    echo "   nerb        = nixos-edit-rebuild (which calls this)"
    echo "   herb        = home-edit-rebuild (which calls this)"
    echo "   nup         = nixos-upgrade (which calls this)"
    echo ""
    echo "ğŸ†˜ TROUBLESHOOTING:"
    echo "   â€¢ Build hangs: Check disk space and memory usage"
    echo "   â€¢ Rollback fails: Select previous generation at boot menu"
    echo "   â€¢ Git issues: Manually run 'nixos-git \"message\"'"
    echo "   â€¢ Flake errors: Check flake.nix syntax and inputs"
end
